/**
 * Get Comments
 * Fetches and displays comments for a news article
 */

// Get news ID from hidden element
const newsIdElement = document.getElementById('ID_News');
const commentsSection = document.getElementById('comments');

// Check if elements exist
if (!newsIdElement || !commentsSection) {
  console.warn('Required elements not found for comments');
} else {
  const newsId = newsIdElement.innerText;

  /**
   * Fetch and render comments from server
   */
  function loadComments() {
    fetch(`/comments-news/${newsId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(comments => {
        renderComments(comments);
      })
      .catch(error => {
        console.error('Error fetching comments:', error);
        showError('Failed to load comments. Please try again later.');
      });
  }

  /**
   * Render comments in the DOM
   * @param {Array} comments - Array of comment objects
   */
  function renderComments(comments) {
    // Find or create comments list container
    let commentsList = commentsSection.querySelector('.comments__list');
    
    if (!commentsList) {
      commentsList = document.createElement('div');
      commentsList.classList.add('comments__list');
      commentsSection.appendChild(commentsList);
    }

    // Clear existing comments
    commentsList.innerHTML = '';

    // Check if there are any comments
    if (comments.length === 0) {
      const noCommentsMsg = document.createElement('p');
      noCommentsMsg.classList.add('comments__empty');
      noCommentsMsg.textContent = 'No comments yet. Be the first to comment!';
      noCommentsMsg.style.cssText = 'color: rgba(255, 255, 255, 0.7); font-size: 1.6rem; text-align: center; padding: 2rem 0;';
      commentsList.appendChild(noCommentsMsg);
      return;
    }

    // Render each comment
    comments.forEach(comment => {
      const commentElement = createCommentElement(comment);
      commentsList.appendChild(commentElement);
    });
  }

  /**
   * Create a single comment DOM element
   * @param {Object} comment - Comment object with content, author, date_created
   * @returns {HTMLElement} - Comment element
   */
  function createCommentElement(comment) {
    console.log(comment);
    // Main comment container
    const commentDiv = document.createElement('div');
    commentDiv.classList.add('comments__single');
    commentDiv.classList.add('fade-in');

    // Author wrapper
    const authorWrapper = document.createElement('div');
    authorWrapper.classList.add('comments__author-wrapper');

    // Avatar
    const avatar = document.createElement('div');
    avatar.classList.add('comments__avatar');

    // Author info container
    const authorInfo = document.createElement('div');
    authorInfo.classList.add('comments__author-info');

    // Author name
    const authorName = document.createElement('div');
    authorName.classList.add('comments__author');
    authorName.textContent = comment.authorName || 'Anonymous';

    // Comment date
    const commentDate = document.createElement('div');
    commentDate.classList.add('comments__date');
    commentDate.textContent = formatDate(comment.createdAt);

    // Append author info
    authorInfo.appendChild(authorName);
    authorInfo.appendChild(commentDate);

    // Append to author wrapper
    authorWrapper.appendChild(avatar);
    authorWrapper.appendChild(authorInfo);

    // Comment content
    const commentContent = document.createElement('div');
    commentContent.classList.add('comments__content');
    commentContent.textContent = comment.content;

    // Append all to main container
    commentDiv.appendChild(authorWrapper);
    commentDiv.appendChild(commentContent);

    return commentDiv;
  }

  /**
   * Format date string for display
   * @param {string} dateString - Date string from server
   * @returns {string} - Formatted date
   */
  function formatDate(dateString) {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      // Show relative time for recent comments
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;

      // Otherwise show formatted date
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (error) {
      return dateString; // Fallback to original string if parsing fails
    }
  }

  /**
   * Show error message to user
   * @param {string} message - Error message to display
   */
  function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.classList.add('alert', 'alert--error');
    errorDiv.innerHTML = `<p class="alert__message">${message}</p>`;
    
    document.body.appendChild(errorDiv);
    
    // Remove error message after 5 seconds
    setTimeout(() => {
      errorDiv.remove();
    }, 5000);
  }

  // Initial load
  loadComments();

  // Export loadComments for use in createComment.js
  window.loadComments = loadComments;
}
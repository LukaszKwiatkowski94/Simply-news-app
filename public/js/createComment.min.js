/**
 * Create Comment
 * Handles submission of new comments
 */

// Get DOM elements
const addButton = document.getElementById('AddComment');
const contentTextarea = document.getElementById('contentComment');
const newsIdElement = document.getElementById('ID_News');

// Check if all required elements exist
if (!addButton || !contentTextarea || !newsIdElement) {
  console.warn('Required elements for comment creation not found');
} else {
  /**
   * Handle comment submission
   */
  async function submitComment() {
    // Get values
    const newsId = newsIdElement.innerText;
    const content = contentTextarea.value.trim();

    // Validate content
    if (!content) {
      showAlert('Please enter a comment before submitting.', 'error');
      return;
    }

    if (content.length > 500) {
      showAlert('Comment is too long. Maximum 500 characters allowed.', 'error');
      return;
    }

    // Prepare data
    const data = {
      news: newsId,
      content: content
    };

    // Disable button and show loading state
    addButton.disabled = true;
    const originalText = addButton.textContent;
    addButton.innerHTML = '<span class="spinner"></span> Posting...';

    try {
      // Send POST request
      const response = await fetch('/comments-create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json; charset=UTF-8'
        },
        body: JSON.stringify(data)
      });

      // Check response status
      if (response.status === 200 || response.status === 201) {
        // Success
        showAlert('Comment posted successfully!', 'success');
        
        // Clear textarea
        contentTextarea.value = '';
        
        // Refresh comments list
        if (typeof window.loadComments === 'function') {
          window.loadComments();
        } else {
          // Fallback: reload page if loadComments not available
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      } else {
        // Server returned error
        const errorData = await response.json().catch(() => ({}));
        showAlert(errorData.message || 'Failed to post comment. Please try again.', 'error');
      }
    } catch (error) {
      // Network or other error
      console.error('Error creating comment:', error);
      showAlert('Network error. Please check your connection and try again.', 'error');
    } finally {
      // Re-enable button
      addButton.disabled = false;
      addButton.textContent = originalText;
    }
  }

  /**
   * Show alert message to user
   * @param {string} message - Message to display
   * @param {string} type - Alert type ('success' or 'error')
   */
  function showAlert(message, type = 'success') {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());

    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.classList.add('alert', `alert--${type}`);
    alertDiv.innerHTML = `<p class="alert__message">${message}</p>`;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      alertDiv.style.opacity = '0';
      setTimeout(() => {
        alertDiv.remove();
      }, 300);
    }, 5000);
  }

  /**
   * Validate comment on input (real-time feedback)
   */
  function validateInput() {
    const content = contentTextarea.value.trim();
    const charCount = content.length;
    
    // Update character count if element exists
    const charCounter = document.getElementById('charCounter');
    if (charCounter) {
      charCounter.textContent = `${charCount}/500`;
      
      if (charCount > 500) {
        charCounter.style.color = 'rgb(252, 165, 165)';
      } else {
        charCounter.style.color = 'rgba(255, 255, 255, 0.7)';
      }
    }
  }

  // Event listeners
  addButton.addEventListener('click', submitComment);

  // Optional: Submit on Ctrl+Enter
  contentTextarea.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
      event.preventDefault();
      submitComment();
    }
  });

  // Optional: Real-time validation
  contentTextarea.addEventListener('input', validateInput);
}